version: 0.2

env:
  variables:
    AWS_ACCOUNT_ID: "586359898361"
    IMAGE_REPO_NAME: "nartex-next"
    NEXTAUTH_URL: "https://app.nartex.ca"
    EMAIL_SERVER_HOST: "smtp.gmail.com"
    EMAIL_SERVER_PORT: "587"
    EMAIL_SERVER_USER: "n.labranche@nartex.ca"
    EMAIL_FROM: "Nartex <noreply@nartex.ca>"
    AZURE_AD_TENANT_ID: "organizations"

  secrets-manager:
    DATABASE_URL:           nartex/prod/env:DATABASE_URL
    EMAIL_SERVER_PASSWORD:  nartex/prod/env:EMAIL_SERVER_PASSWORD
    NEXTAUTH_SECRET:        nartex/prod/env:NEXTAUTH_SECRET
    GOOGLE_CLIENT_ID:       nartex/prod/env:GOOGLE_CLIENT_ID
    GOOGLE_CLIENT_SECRET:   nartex/prod/env:GOOGLE_CLIENT_SECRET
    AZURE_AD_CLIENT_ID:     nartex/prod/env:AZURE_AD_CLIENT_ID
    AZURE_AD_CLIENT_SECRET: nartex/prod/env:AZURE_AD_CLIENT_SECRET

phases:
  install:
    runtime-versions:
      nodejs: 18
    commands:
      - echo "ðŸ“¦ INSTALL â€“ npm ci for workspace tooling"
      - npm ci

  pre_build:
    commands:
      - echo "ðŸ“œ PRE_BUILD â€“ run scripted steps under bash"
      - |
        bash -lc '
          set -euo pipefail

          echo "âž• deps for dashboard"
          npm pkg set dependencies.recharts="^2.12.7"
          npm pkg set dependencies.lucide-react="^0.452.0"
          npm pkg set dependencies.class-variance-authority="^0.7.0"
          npm pkg set dependencies.clsx="^2.1.1"
          npm pkg set dependencies.tailwind-merge="^2.5.2"
          npm pkg set dependencies.tailwindcss-animate="^1.0.7"

          echo "ðŸ§± ensure shadcn targets src/components + aliases"
          node -e "
            const fs=require('fs');
            const p='components.json';
            if (fs.existsSync(p)) {
              const j=JSON.parse(fs.readFileSync(p,'utf8'));
              j.path='src/components';
              j.aliases={components:'@/components', utils:'@/lib/utils'};
              fs.writeFileSync(p, JSON.stringify(j,null,2));
            } else {
              const j={
                $schema:'https://ui.shadcn.com/schema.json',
                style:'default', rsc:true, tsx:true,
                tailwind:{config:'tailwind.config.ts', css:'src/app/globals.css', baseColor:'gray', cssVariables:true},
                aliases:{components:'@/components', utils:'@/lib/utils'},
                iconLibrary:'lucide',
                components:[],
                path:'src/components'
              };
              fs.writeFileSync(p, JSON.stringify(j,null,2));
            }"

          echo "ðŸ§© generate components only if missing"
          mkdir -p src/lib src/components/ui

          if [ ! -f src/lib/utils.ts ]; then
            cat > src/lib/utils.ts << "TS"
import { type ClassValue } from "clsx";
import clsx from "clsx";
import { twMerge } from "tailwind-merge";
export function cn(...inputs: ClassValue[]) { return twMerge(clsx(inputs)); }
TS
          fi

          # init once (shadcn init fails if components.json already exists)
          if [ ! -f .shadcn-initialized ]; then
            npx --yes shadcn@latest init -d || true
            touch .shadcn-initialized
          fi

          add_if_missing () {
            NAME="$1"
            if [ ! -f "src/components/ui/${NAME}.tsx" ] && [ ! -f "src/components/ui/${NAME}.ts" ]; then
              echo "Adding $NAME"
              npx --yes shadcn@latest add "$NAME"
            else
              echo "Skipping $NAME (already exists)"
            fi
          }
          for c in button card table tabs input select badge; do add_if_missing "$c"; done

          echo "ðŸ“‚ verify path"
          ls -la src/components/ui || true

          echo "ðŸ”’ refresh lockfile"
          npm install --package-lock-only --ignore-scripts --no-audit --no-fund

          echo "ðŸ”‘ ECR login"
          PASS="$(aws ecr get-login-password --region "$AWS_DEFAULT_REGION")"
          echo "$PASS" | docker login --username AWS --password-stdin "$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com"
        '

  build:
    commands:
      - echo "ðŸ— BUILD â€“ resolve commit hash"
      - COMMIT_HASH=$(git rev-parse --short HEAD)
      - echo "ðŸ— BUILD â€“ docker image (no cache)"
      - ECR_IMAGE_URI="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$IMAGE_REPO_NAME"
      - |
        docker build \
          --no-cache \
          --build-arg GIT_COMMIT_HASH=$COMMIT_HASH \
          --build-arg DATABASE_URL="$DATABASE_URL" \
          --build-arg EMAIL_SERVER_HOST="$EMAIL_SERVER_HOST" \
          --build-arg EMAIL_SERVER_PORT="$EMAIL_SERVER_PORT" \
          --build-arg EMAIL_SERVER_USER="$EMAIL_SERVER_USER" \
          --build-arg EMAIL_SERVER_PASSWORD="$EMAIL_SERVER_PASSWORD" \
          --build-arg EMAIL_FROM="$EMAIL_FROM" \
          --build-arg NEXTAUTH_URL="$NEXTAUTH_URL" \
          --build-arg NEXTAUTH_SECRET="$NEXTAUTH_SECRET" \
          --build-arg GOOGLE_CLIENT_ID="$GOOGLE_CLIENT_ID" \
          --build-arg GOOGLE_CLIENT_SECRET="$GOOGLE_CLIENT_SECRET" \
          --build-arg AZURE_AD_CLIENT_ID="$AZURE_AD_CLIENT_ID" \
          --build-arg AZURE_AD_CLIENT_SECRET="$AZURE_AD_CLIENT_SECRET" \
          --build-arg AZURE_AD_TENANT_ID="$AZURE_AD_TENANT_ID" \
          -t "$ECR_IMAGE_URI:$COMMIT_HASH" \
          -t "$ECR_IMAGE_URI:latest" .
      - echo "ðŸ“¤ Push images"
      - docker push "$ECR_IMAGE_URI:$COMMIT_HASH"
      - docker push "$ECR_IMAGE_URI:latest"

  post_build:
    commands:
      - echo "ðŸ”„ Force new ECS deployment"
      - |
        aws ecs update-service \
          --cluster nartex-cluster \
          --service nartex-next-service \
          --force-new-deployment \
          --region $AWS_DEFAULT_REGION

artifacts:
  files:
    - imagedefinitions.json
