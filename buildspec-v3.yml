version: 0.2

env:
  variables:
    # â”€â”€â”€â”€â”€ AWS / image info â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    AWS_ACCOUNT_ID     : "586359898361"
    AWS_DEFAULT_REGION : "ca-central-1"
    IMAGE_REPO_NAME    : "nartex-next"

    # â”€â”€â”€â”€â”€ Mail / NextAuth (edit to real creds) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    EMAIL_SERVER_HOST      : "smtp.mailgun.org"
    EMAIL_SERVER_PORT      : "587"
    EMAIL_SERVER_USER      : "postmaster@smtp.mailgun.org"
    EMAIL_SERVER_PASSWORD  : "superâ€‘longâ€‘smtpâ€‘password"
    NEXTAUTH_URL           : "https://nartex.app"

  secrets-manager:
    DATABASE_URL : nartex-db-credentials

phases:
  install:
    runtime-versions:
      nodejs: 18
    commands:
      - echo "ğŸ“¦  INSTALL â€“ installing Node dependencies"
      - npm ci

  pre_build:
    commands:
      - echo "ğŸ“œ  Running Prisma migrations"
      - npx prisma migrate deploy
      - echo "ğŸ”‘  PRE_BUILD â€“ logging in to AmazonÂ ECR"
      - aws ecr get-login-password --region "$AWS_DEFAULT_REGION" | docker login --username AWS --password-stdin "$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com"

  build:
    commands:
      - echo "ğŸ—  BUILD â€“ resolving commit hash"
      - COMMIT_HASH=$(git rev-parse --short HEAD)
  
      # â”€â”€â”€ Write a .env.production file into the build context â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - printf '%s\n' \
          "EMAIL_SERVER_HOST=$EMAIL_SERVER_HOST" \
          "EMAIL_SERVER_PORT=$EMAIL_SERVER_PORT" \
          "EMAIL_SERVER_USER=$EMAIL_SERVER_USER" \
          "EMAIL_SERVER_PASSWORD=$EMAIL_SERVER_PASSWORD" \
          "NEXTAUTH_URL=$NEXTAUTH_URL" \
        > .env.production
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
      - echo "ğŸ—  BUILD â€“ building Docker image"
      - |
        ECR_IMAGE_URI="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$IMAGE_REPO_NAME"
        docker build -t "$ECR_IMAGE_URI:$COMMIT_HASH" -t "$ECR_IMAGE_URI:latest" .
  
      - echo "ğŸ—  BUILD â€“ pushing both tags to ECR"
      - docker push "$ECR_IMAGE_URI:$COMMIT_HASH"
      - docker push "$ECR_IMAGE_URI:latest"
  
      # optional alias
      - docker tag "$ECR_IMAGE_URI:latest" nartex-next-prod:latest
      - docker push "$ECR_IMAGE_URI:latest"

  post_build:
    commands:
      - echo 'ğŸ”„  Updating ECS service with safe rollout settings'
      - aws ecs update-service \
          --cluster nartex-cluster \
          --service nartex-next-service \
          --task-definition nartex-next-task:"$CODEBUILD_RESOLVED_SOURCE_VERSION" \
          --desired-count 2 \
          --force-new-deployment \
          --deployment-configuration \
              maximumPercent=200,minimumHealthyPercent=50, \
              deploymentCircuitBreaker={enable=true,rollback=true} \
          --region $AWS_DEFAULT_REGION

artifacts:
  files:
    - imagedefinitions.json
