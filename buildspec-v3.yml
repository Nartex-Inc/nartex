version: 0.2

env:
  variables:
    AWS_ACCOUNT_ID: "586359898361"
    IMAGE_REPO_NAME: "nartex-next"
    NEXTAUTH_URL: "https://app.nartex.ca"
    EMAIL_SERVER_HOST: "smtp.gmail.com"
    EMAIL_SERVER_PORT: "587"
    EMAIL_SERVER_USER: "n.labranche@nartex.ca"
    EMAIL_FROM: "Nartex <noreply@nartex.ca>"
    AZURE_AD_TENANT_ID: "organizations"

  secrets-manager:
    DATABASE_URL:           nartex/prod/env:DATABASE_URL
    EMAIL_SERVER_PASSWORD:  nartex/prod/env:EMAIL_SERVER_PASSWORD
    NEXTAUTH_SECRET:        nartex/prod/env:NEXTAUTH_SECRET
    GOOGLE_CLIENT_ID:       nartex/prod/env:GOOGLE_CLIENT_ID
    GOOGLE_CLIENT_SECRET:   nartex/prod/env:GOOGLE_CLIENT_SECRET
    AZURE_AD_CLIENT_ID:     nartex/prod/env:AZURE_AD_CLIENT_ID
    AZURE_AD_CLIENT_SECRET: nartex/prod/env:AZURE_AD_CLIENT_SECRET

phases:
  install:
    runtime-versions:
      nodejs: 18
    commands:
      - echo "üì¶  INSTALL ‚Äì installing Node dependencies"
      - npm ci

  pre_build:
    commands:
      - echo "üìú  PRE_BUILD ‚Äì running Prisma migrations"
      - npx prisma migrate deploy
      - echo "üìú  PRE_BUILD ‚Äì generating Prisma Client"
      - npx prisma generate
      - echo "üîë  PRE_BUILD ‚Äì logging in to Amazon ECR"
      - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com

    build:
      commands:
        - echo "üèó  BUILD ‚Äì resolving commit hash"
        - COMMIT_HASH=$(git rev-parse --short HEAD)
        - echo "üèó  BUILD ‚Äì building Docker image with all environment variables as build arguments"
        - ECR_IMAGE_URI="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$IMAGE_REPO_NAME"
        - |
          docker build \
            --build-arg GIT_COMMIT_HASH=$COMMIT_HASH \
            --build-arg DATABASE_URL="$DATABASE_URL" \
            --build-arg EMAIL_SERVER_HOST="$EMAIL_SERVER_HOST" \
            --build-arg EMAIL_SERVER_PORT="$EMAIL_SERVER_PORT" \
            --build-arg EMAIL_SERVER_USER="$EMAIL_SERVER_USER" \
            --build-arg EMAIL_SERVER_PASSWORD="$EMAIL_SERVER_PASSWORD" \
            --build-arg EMAIL_FROM="$EMAIL_FROM" \
            --build-arg NEXTAUTH_URL="$NEXTAUTH_URL" \
            --build-arg NEXTAUTH_SECRET="$NEXTAUTH_SECRET" \
            --build-arg GOOGLE_CLIENT_ID="$GOOGLE_CLIENT_ID" \
            --build-arg GOOGLE_CLIENT_SECRET="$GOOGLE_CLIENT_SECRET" \
            --build-arg AZURE_AD_CLIENT_ID="$AZURE_AD_CLIENT_ID" \
            --build-arg AZURE_AD_CLIENT_SECRET="$AZURE_AD_CLIENT_SECRET" \
            --build-arg AZURE_AD_TENANT_ID="$AZURE_AD_TENANT_ID" \
            -t "$ECR_IMAGE_URI:$COMMIT_HASH" \
            -t "$ECR_IMAGE_URI:latest" .
        - echo "üì§  BUILD ‚Äì pushing both tags to ECR"
        - docker push "$ECR_IMAGE_URI:$COMMIT_HASH"
        - docker push "$ECR_IMAGE_URI:latest"

  post_build:
    commands:
      - echo 'üîÑ  POST_BUILD ‚Äì forcing new deployment of ECS service'
      - |
        aws ecs update-service \
          --cluster nartex-cluster \
          --service nartex-next-service \
          --force-new-deployment \
          --region $AWS_DEFAULT_REGION

artifacts:
  files:
    - imagedefinitions.json
