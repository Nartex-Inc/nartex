version: 0.2

env:
  variables:
    # â”€â”€â”€â”€â”€ Non-sensitive AWS / image info â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    AWS_ACCOUNT_ID: "586359898361"
    AWS_DEFAULT_REGION: "ca-central-1"
    IMAGE_REPO_NAME: "nartex-next"

    # â”€â”€â”€â”€â”€ Non-sensitive application configuration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    NEXTAUTH_URL: "https://nartex.app" # IMPORTANT: Use your production URL
    EMAIL_SERVER_HOST: "smtp.gmail.com"
    EMAIL_SERVER_PORT: "587"
    EMAIL_SERVER_USER: "n.labranche@nartex.ca"
    EMAIL_FROM: "Nartex <noreply@nartex.ca>"

  secrets-manager:
    # â”€â”€â”€â”€â”€ All sensitive credentials are fetched from the new secret â”€â”€â”€â”€â”€â”€
    # SYNTAX: <variable_name_in_build>: <secret_name>:<key_in_secret>
    DATABASE_URL:           nartex/prod/env:DATABASE_URL
    EMAIL_SERVER_PASSWORD:  nartex/prod/env:EMAIL_SERVER_PASSWORD
    NEXTAUTH_SECRET:        nartex/prod/env:NEXTAUTH_SECRET
    GOOGLE_CLIENT_ID:       nartex/prod/env:GOOGLE_CLIENT_ID
    GOOGLE_CLIENT_SECRET:   nartex/prod/env:GOOGLE_CLIENT_SECRET
    AZURE_AD_CLIENT_ID:     nartex/prod/env:AZURE_AD_CLIENT_ID
    AZURE_AD_CLIENT_SECRET: nartex/prod/env:AZURE_AD_CLIENT_SECRET
    AZURE_AD_TENANT_ID:     nartex/prod/env:AZURE_AD_TENANT_ID

phases:
  install:
    runtime-versions: { nodejs: 18 }
    commands:
      - echo "ğŸ“¦  INSTALL â€“ installing Node dependencies"
      - npm ci

  pre_build:
    commands:
      - echo "ğŸ“œ  Running Prisma migrations"
      - npx prisma migrate deploy
      - echo "ğŸ”‘  PRE_BUILD â€“ logging in to Amazon ECR"
      - aws ecr get-login-password --region "$AWS_DEFAULT_REGION" | docker login --username AWS --password-stdin "$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com"

    build:
      commands:
        - echo "ğŸ—  BUILD â€“ resolving commit hash"
        - COMMIT_HASH=$(git rev-parse --short HEAD)
  
        # â”€â”€â”€ Write ALL environment variables into the .env.production file â”€â”€â”€
        # This file will be copied into the final Docker image for runtime use.
        - echo "ğŸ“  BUILD â€“ creating .env.production file"
        - printf '%s\n' \
            "DATABASE_URL=$DATABASE_URL" \
            "EMAIL_SERVER_HOST=$EMAIL_SERVER_HOST" \
            "EMAIL_SERVER_PORT=$EMAIL_SERVER_PORT" \
            "EMAIL_SERVER_USER=$EMAIL_SERVER_USER" \
            "EMAIL_SERVER_PASSWORD=$EMAIL_SERVER_PASSWORD" \
            "EMAIL_FROM=$EMAIL_FROM" \
            "NEXTAUTH_URL=$NEXTAUTH_URL" \
            "NEXTAUTH_SECRET=$NEXTAUTH_SECRET" \
            "GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID" \
            "GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET" \
            "AZURE_AD_CLIENT_ID=$AZURE_AD_CLIENT_ID" \
            "AZURE_AD_CLIENT_SECRET=$AZURE_AD_CLIENT_SECRET" \
            "AZURE_AD_TENANT_ID=$AZURE_AD_TENANT_ID" \
          > .env.production
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
        - echo "ğŸ—  BUILD â€“ building Docker image with consistent Build ID"
        - ECR_IMAGE_URI="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$IMAGE_REPO_NAME"
        
        # --- THIS IS THE FIXED DOCKER BUILD COMMAND ---
        # It passes the GIT_COMMIT_HASH to the Dockerfile via --build-arg.
        # The literal block style `|` ensures it is parsed correctly by CodeBuild.
        - |
          docker build \
            --build-arg GIT_COMMIT_HASH=$COMMIT_HASH \
            -t "$ECR_IMAGE_URI:$COMMIT_HASH" \
            -t "$ECR_IMAGE_URI:latest" .
  
        - echo "ğŸ“¤  Pushing both tags to ECR"
        - docker push "$ECR_IMAGE_URI:$COMMIT_HASH"
        - docker push "$ECR_IMAGE_URI:latest"

    post_build:
      commands:
        - echo 'ğŸ”„  POST_BUILD â€“ forcing new deployment of ECS service'
        - |
          aws ecs update-service \
            --cluster nartex-cluster \
            --service nartex-next-service \
            --force-new-deployment \
            --region $AWS_DEFAULT_REGION

# The artifacts section is not strictly needed when deploying directly from the build stage,
# but it's good practice to keep it for potential future pipeline structures.
artifacts:
  files:
    - imagedefinitions.json
