version: 0.2

env:
  variables:
    AWS_DEFAULT_REGION: "ca-central-1"
    AWS_ACCOUNT_ID: "586359898361"
    IMAGE_REPO_NAME: "nartex-next"
    CONTAINER_NAME: "nextjs"           # must match the container name in the task def
    ECS_CLUSTER: "nartex-cluster"
    ECS_SERVICE: "nartex-next-service"

    NEXTAUTH_URL: "https://app.nartex.ca"
    EMAIL_SERVER_HOST: "smtp.gmail.com"
    EMAIL_SERVER_PORT: "587"
    EMAIL_SERVER_USER: "n.labranche@nartex.ca"
    EMAIL_FROM: "Nartex <noreply@nartex.ca>"
    AZURE_AD_TENANT_ID: "organizations"

  secrets-manager:
    DATABASE_URL:           nartex/prod/env:DATABASE_URL
    EMAIL_SERVER_PASSWORD:  nartex/prod/env:EMAIL_SERVER_PASSWORD
    NEXTAUTH_SECRET:        nartex/prod/env:NEXTAUTH_SECRET
    GOOGLE_CLIENT_ID:       nartex/prod/env:GOOGLE_CLIENT_ID
    GOOGLE_CLIENT_SECRET:   nartex/prod/env:GOOGLE_CLIENT_SECRET
    AZURE_AD_CLIENT_ID:     nartex/prod/env:AZURE_AD_CLIENT_ID
    AZURE_AD_CLIENT_SECRET: nartex/prod/env:AZURE_AD_CLIENT_SECRET
    RDS_CREDENTIALS:        nartex/prod/rds-credentials

phases:
  install:
    runtime-versions:
      nodejs: 18
    commands:
      - echo "ðŸ“¦ INSTALL â€“ npm ci"
      - npm ci
      # jq for JSON edits (Ubuntu or Amazon Linux)
      - |
        if command -v apt-get >/dev/null 2>&1; then
          apt-get update && apt-get install -y jq
        elif command -v yum >/dev/null 2>&1; then
          yum install -y jq
        fi

  pre_build:
    commands:
      - echo "ðŸ“œ PRE_BUILD â€“ ensure expected deps (idempotent) and project stubs"
      - npm pkg set dependencies.recharts="^2.12.7" \
                    dependencies.lucide-react="^0.452.0" \
                    dependencies.class-variance-authority="^0.7.0" \
                    dependencies.clsx="^2.1.1" \
                    dependencies.tailwind-merge="^2.5.2" \
                    dependencies.tailwindcss-animate="^1.0.7" \
                    dependencies.pg="^8.11.3" \
                    dependencies.swr="^2.3.0" \
                    dependencies.@next-auth/prisma-adapter="^1.0.7"
      - npm pkg set devDependencies.@types/node="^18.19.0" devDependencies.@types/pg="^8.11.7"

  build:
    commands:
      - echo "ðŸ— BUILD â€“ resolve commit hash"
      - COMMIT_HASH=$(git rev-parse --short HEAD)
      - ECR_REGISTRY="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com"
      - ECR_IMAGE_URI="$ECR_REGISTRY/$IMAGE_REPO_NAME"
      - echo "ðŸ”§ Using $ECR_IMAGE_URI:$COMMIT_HASH"

      - echo "ðŸ³ Docker build"
      - |
        docker build \
          --build-arg GIT_COMMIT_HASH=$COMMIT_HASH \
          --build-arg DATABASE_URL="$DATABASE_URL" \
          --build-arg EMAIL_SERVER_HOST="$EMAIL_SERVER_HOST" \
          --build-arg EMAIL_SERVER_PORT="$EMAIL_SERVER_PORT" \
          --build-arg EMAIL_SERVER_USER="$EMAIL_SERVER_USER" \
          --build-arg EMAIL_SERVER_PASSWORD="$EMAIL_SERVER_PASSWORD" \
          --build-arg EMAIL_FROM="$EMAIL_FROM" \
          --build-arg NEXTAUTH_URL="$NEXTAUTH_URL" \
          --build-arg NEXTAUTH_SECRET="$NEXTAUTH_SECRET" \
          --build-arg GOOGLE_CLIENT_ID="$GOOGLE_CLIENT_ID" \
          --build-arg GOOGLE_CLIENT_SECRET="$GOOGLE_CLIENT_SECRET" \
          --build-arg AZURE_AD_CLIENT_ID="$AZURE_AD_CLIENT_ID" \
          --build-arg AZURE_AD_CLIENT_SECRET="$AZURE_AD_CLIENT_SECRET" \
          --build-arg AZURE_AD_TENANT_ID="$AZURE_AD_TENANT_ID" \
          -t "$ECR_IMAGE_URI:$COMMIT_HASH" \
          -t "$ECR_IMAGE_URI:latest" .

      - echo "ðŸ”‘ Login to ECR registry"
      - aws ecr get-login-password --region "$AWS_DEFAULT_REGION" \
        | docker login --username AWS --password-stdin "$ECR_REGISTRY"

      - echo "ðŸ“¤ Push images"
      - docker push "$ECR_IMAGE_URI:$COMMIT_HASH"
      - docker push "$ECR_IMAGE_URI:latest"

  post_build:
    commands:
      - echo "ðŸ§¾ Prepare new task definition with image tag $COMMIT_HASH"
      - TD_ARN=$(aws ecs describe-services --cluster "$ECS_CLUSTER" --services "$ECS_SERVICE" --query 'services[0].taskDefinition' --output text)
      - aws ecs describe-task-definition --task-definition "$TD_ARN" --query 'taskDefinition' > td.json

      # swap only the image for the named container, strip read-only fields
      - |
        NEW_IMAGE="$ECR_IMAGE_URI:$COMMIT_HASH"
        jq --arg name "$CONTAINER_NAME" --arg img "$NEW_IMAGE" '
          .containerDefinitions |=
            (map(if .name==$name then .image=$img else . end)) |
          del(.taskDefinitionArn,
              .revision,
              .status,
              .requiresAttributes,
              .compatibilities,
              .registeredAt,
              .registeredBy)
        ' td.json > td_reg.json
        cat td_reg.json

      - echo "ðŸ“Œ Register new task definition revision"
      - NEW_TD_ARN=$(aws ecs register-task-definition --cli-input-json file://td_reg.json --query 'taskDefinition.taskDefinitionArn' --output text)
      - echo "New task definition: $NEW_TD_ARN"

      - echo "ðŸš€ Update service to new task definition"
      - aws ecs update-service --cluster "$ECS_CLUSTER" --service "$ECS_SERVICE" --task-definition "$NEW_TD_ARN" --region "$AWS_DEFAULT_REGION" > /dev/null

      - echo "ðŸ“œ Latest ECS events:"
      - |
        aws ecs describe-services \
          --cluster "$ECS_CLUSTER" \
          --services "$ECS_SERVICE" \
          --query 'services[0].events[0:10].[createdAt,message]' \
          --output table \
          --region "$AWS_DEFAULT_REGION"
