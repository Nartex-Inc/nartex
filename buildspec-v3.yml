version: 0.2

env:
  variables:
    AWS_DEFAULT_REGION: "ca-central-1"
    AWS_ACCOUNT_ID: "586359898361"
    IMAGE_REPO_NAME: "nartex-next"

    # App env that you pass into the Docker build
    NEXTAUTH_URL: "https://app.nartex.ca"
    EMAIL_SERVER_HOST: "smtp.gmail.com"
    EMAIL_SERVER_PORT: "587"
    EMAIL_SERVER_USER: "n.labranche@nartex.ca"
    EMAIL_FROM: "Nartex <noreply@nartex.ca>"
    AZURE_AD_TENANT_ID: "organizations"

    # ECS targets (adjust to your real names)
    CLUSTER_NAME: "nartex-cluster"
    SERVICE_NAME: "nartex-next-service"

  secrets-manager:
    DATABASE_URL:           nartex/prod/env:DATABASE_URL
    EMAIL_SERVER_PASSWORD:  nartex/prod/env:EMAIL_SERVER_PASSWORD
    NEXTAUTH_SECRET:        nartex/prod/env:NEXTAUTH_SECRET
    GOOGLE_CLIENT_ID:       nartex/prod/env:GOOGLE_CLIENT_ID
    GOOGLE_CLIENT_SECRET:   nartex/prod/env:GOOGLE_CLIENT_SECRET
    AZURE_AD_CLIENT_ID:     nartex/prod/env:AZURE_AD_CLIENT_ID
    AZURE_AD_CLIENT_SECRET: nartex/prod/env:AZURE_AD_CLIENT_SECRET
    RDS_CREDENTIALS:        nartex/prod/rds-credentials

phases:
  install:
    runtime-versions:
      nodejs: 18
    commands:
      - echo "ðŸ“¦ INSTALL â€“ npm ci for build tooling"
      - npm ci

  pre_build:
    commands:
      - set -euxo pipefail
      - echo "ðŸ“œ PRE_BUILD â€“ patch runtime deps and refresh lockfile"
      - |
        node <<'NODE'
        const fs = require('fs');
        const pkg = JSON.parse(fs.readFileSync('package.json','utf8'));
        pkg.dependencies ||= {};
        const want = {
          "recharts": "^2.12.7",
          "lucide-react": "^0.452.0",
          "class-variance-authority": "^0.7.0",
          "clsx": "^2.1.1",
          "tailwind-merge": "^2.5.2",
          "tailwindcss-animate": "^1.0.7",
          "pg": "^8.11.3",
          "swr": "^2.3.0",
          "@next-auth/prisma-adapter": "^1.0.7"
        };
        let changed = false;
        for (const [k,v] of Object.entries(want)) {
          if (!pkg.dependencies[k]) { pkg.dependencies[k] = v; changed = true; }
        }
        pkg.devDependencies ||= {};
        if (!pkg.devDependencies["@types/node"]) { pkg.devDependencies["@types/node"] = "^18.19.0"; changed = true; }
        if (!pkg.devDependencies["@types/pg"])   { pkg.devDependencies["@types/pg"]   = "^8.11.7";   changed = true; }
        if (changed) fs.writeFileSync('package.json', JSON.stringify(pkg,null,2));
        console.log(changed ? "package.json updated" : "package.json already OK");
        NODE
      - npm install --package-lock-only --ignore-scripts --no-audit --no-fund

      # Compute image coordinates for this phase (and print them for debugging)
      - export COMMIT_HASH="$(git rev-parse --short HEAD)"
      - export ECR_IMAGE_URI="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$IMAGE_REPO_NAME"
      - echo "ðŸ§¾ Will build: ${ECR_IMAGE_URI}:${COMMIT_HASH}"

      # ECR login (needed again before pushing)
      - aws ecr get-login-password --region "$AWS_DEFAULT_REGION" \
          | docker login --username AWS --password-stdin "$ECR_IMAGE_URI"

  build:
    commands:
      - set -euxo pipefail
      # Recompute here because each phase uses a new shell
      - export COMMIT_HASH="$(git rev-parse --short HEAD)"
      - export ECR_IMAGE_URI="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$IMAGE_REPO_NAME"
      - echo "ðŸ— BUILD â€“ docker image ${ECR_IMAGE_URI}:${COMMIT_HASH}"

      - |
        docker build \
          --build-arg GIT_COMMIT_HASH="$COMMIT_HASH" \
          --build-arg DATABASE_URL="$DATABASE_URL" \
          --build-arg EMAIL_SERVER_HOST="$EMAIL_SERVER_HOST" \
          --build-arg EMAIL_SERVER_PORT="$EMAIL_SERVER_PORT" \
          --build-arg EMAIL_SERVER_USER="$EMAIL_SERVER_USER" \
          --build-arg EMAIL_SERVER_PASSWORD="$EMAIL_SERVER_PASSWORD" \
          --build-arg EMAIL_FROM="$EMAIL_FROM" \
          --build-arg NEXTAUTH_URL="$NEXTAUTH_URL" \
          --build-arg NEXTAUTH_SECRET="$NEXTAUTH_SECRET" \
          --build-arg GOOGLE_CLIENT_ID="$GOOGLE_CLIENT_ID" \
          --build-arg GOOGLE_CLIENT_SECRET="$GOOGLE_CLIENT_SECRET" \
          --build-arg AZURE_AD_CLIENT_ID="$AZURE_AD_CLIENT_ID" \
          --build-arg AZURE_AD_CLIENT_SECRET="$AZURE_AD_CLIENT_SECRET" \
          --build-arg AZURE_AD_TENANT_ID="$AZURE_AD_TENANT_ID" \
          -t "$ECR_IMAGE_URI:$COMMIT_HASH" \
          -t "$ECR_IMAGE_URI:latest" .

      - echo "ðŸ” ECR login (again, just before push)"
      - aws ecr get-login-password --region "$AWS_DEFAULT_REGION" \
          | docker login --username AWS --password-stdin "$ECR_IMAGE_URI"

      - echo "ðŸ“¤ Push images"
      - docker push "$ECR_IMAGE_URI:$COMMIT_HASH"
      - docker push "$ECR_IMAGE_URI:latest"

  post_build:
    commands:
      - set -euxo pipefail
      - echo "ðŸ”„ Force new ECS deployment (CodeBuild-only)"
      - |
        aws ecs update-service \
          --cluster "$CLUSTER_NAME" \
          --service "$SERVICE_NAME" \
          --force-new-deployment \
          --region "$AWS_DEFAULT_REGION"

        echo "â³ Waiting for service to stabilizeâ€¦"
        aws ecs wait services-stable \
          --cluster "$CLUSTER_NAME" \
          --services "$SERVICE_NAME" \
          --region "$AWS_DEFAULT_REGION"

      - echo "âœ… ECS deployment complete."

artifacts:
  files: []
