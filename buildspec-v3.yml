version: 0.2

env:
  variables:
    AWS_DEFAULT_REGION: "ca-central-1"
    AWS_ACCOUNT_ID: "586359898361"
    IMAGE_REPO_NAME: "nartex-next"
    # Must match the "name" field in your Task Definition container.
    CONTAINER_NAME: "nextjs"
    NEXTAUTH_URL: "https://app.nartex.ca"
    EMAIL_SERVER_HOST: "smtp.gmail.com"
    EMAIL_SERVER_PORT: "587"
    EMAIL_SERVER_USER: "n.labranche@nartex.ca"
    EMAIL_FROM: "Nartex <noreply@nartex.ca>"
    AZURE_AD_TENANT_ID: "organizations"

  secrets-manager:
    DATABASE_URL: nartex/prod/env:DATABASE_URL
    EMAIL_SERVER_PASSWORD: nartex/prod/env:EMAIL_SERVER_PASSWORD
    NEXTAUTH_SECRET: nartex/prod/env:NEXTAUTH_SECRET
    GOOGLE_CLIENT_ID: nartex/prod/env:GOOGLE_CLIENT_ID
    GOOGLE_CLIENT_SECRET: nartex/prod/env:GOOGLE_CLIENT_SECRET
    AZURE_AD_CLIENT_ID: nartex/prod/env:AZURE_AD_CLIENT_ID
    AZURE_AD_CLIENT_SECRET: nartex/prod/env:AZURE_AD_CLIENT_SECRET
    RDS_CREDENTIALS: nartex/prod/rds-credentials

phases:
  install:
    runtime-versions:
      nodejs: 18
    commands:
      - echo "ðŸ“¦ INSTALL â€“ clean cache and install deps"
      - npm cache clean --force
      - npm ci

  pre_build:
    commands:
      - echo "ðŸ“œ PRE_BUILD â€“ preparing workspace"
      - |
        cat > ci-prebuild.sh << 'SH'
        set -euo pipefail
        set -x
        
        # Remove legacy file if present to avoid conflicts
        rm -f src/lib/auth.ts || true
        
        # Ensure runtime & dev deps (idempotent)
        npm pkg set dependencies.recharts="^2.12.7"
        npm pkg set dependencies.lucide-react="^0.452.0"
        npm pkg set dependencies.class-variance-authority="^0.7.0"
        npm pkg set dependencies.clsx="^2.1.1"
        npm pkg set dependencies.tailwind-merge="^2.5.2"
        npm pkg set dependencies.tailwindcss-animate="^1.0.7"
        npm pkg set dependencies.pg="^8.11.3"
        npm pkg set dependencies.swr="^2.3.0"
        npm pkg set dependencies.@next-auth/prisma-adapter="^1.0.7"
        npm pkg set devDependencies.@types/node="^18.19.0"
        npm pkg set devDependencies.@types/pg="^8.11.7"
        
        # shadcn config (safe if already exists)
        node <<'NODE'
        const fs = require('fs');
        const p = 'components.json';
        const j = fs.existsSync(p) ? JSON.parse(fs.readFileSync(p,'utf8')) : {};
        j.$schema = 'https://ui.shadcn.com/schema.json';
        j.style = 'default'; j.rsc = true; j.tsx = true;
        j.tailwind = { config: 'tailwind.config.ts', css: 'src/app/globals.css', baseColor: 'gray', cssVariables: true };
        j.aliases = { components: '@/components', utils: '@/lib/utils' };
        j.iconLibrary = 'lucide'; j.components = j.components || []; j.path = 'src/components';
        fs.writeFileSync(p, JSON.stringify(j, null, 2));
        NODE
        
        mkdir -p src/lib src/components/ui src/components/dashboard
        
        # cn() helper if missing
        if [ ! -f src/lib/utils.ts ]; then
          cat > src/lib/utils.ts << 'TS'
        import type { ClassValue } from "clsx";
        import clsx from "clsx";
        import { twMerge } from "tailwind-merge";
        export function cn(...inputs: ClassValue[]) { return twMerge(clsx(inputs)); }
        TS
        fi
        
        # ---- UI stubs used by page.tsx (Card + CardTitle) --------------------
        cat > src/components/ui/card.tsx << 'TSX'
        import * as React from "react";
        import { cn } from "@/lib/utils";
        export function Card({ className = "", children }: React.PropsWithChildren<{ className?: string }>) {
          return <div className={cn("rounded-xl border border-white/10 bg-white/[0.02] p-4", className)}>{children}</div>;
        }
        export function CardTitle({ className = "", icon, children }: React.PropsWithChildren<{ className?: string; icon?: React.ReactNode }>) {
          return <div className={cn("mb-2 flex items-center gap-2 text-sm font-semibold text-gray-200", className)}>{icon}{children}</div>;
        }
        export default Card;
        TSX
        
        # Minimal dashboard stubs if absent (safe no-ops)
        [ -f src/components/nartex-logo.tsx ] || cat > src/components/nartex-logo.tsx << 'TSX'
        export default function NartexLogo({ className="" }: { className?: string }) {
          return <span className={className} style={{ fontWeight: 600, letterSpacing: ".05em" }}>nartex</span>;
        }
        TSX
        
        [ -f src/components/dashboard/header.tsx ] || cat > src/components/dashboard/header.tsx << 'TSX'
        export default function DashboardHeader(){ return <div className="px-4 py-3 text-sm text-muted-foreground">Dashboard Header</div>; }
        TSX
        
        [ -f src/components/dashboard/sidebar.tsx ] || cat > src/components/dashboard/sidebar.tsx << 'TSX'
        export default function DashboardSidebar(){ return <aside className="p-4 text-sm text-muted-foreground">Sidebar</aside>; }
        TSX
        
        [ -f src/components/dashboard/new-product-requests-table.tsx ] || cat > src/components/dashboard/new-product-requests-table.tsx << 'TSX'
        export default function NewProductRequestsTable(){ return <div className="p-4 text-sm text-muted-foreground">New product requests (stub)</div>; }
        TSX
        
        [ -f src/components/product-requests-table.tsx ] || cat > src/components/product-requests-table.tsx << 'TSX'
        export default function ProductRequestsTable(){ return <div className="p-4 text-sm text-muted-foreground">Product requests (stub)</div>; }
        TSX
        
        # ðŸ”§ Auto-insert missing import in the SharePoint page if needed
        node <<'NODE'
        const fs = require('fs');
        const p = 'src/app/dashboard/sharepoint/page.tsx';
        if (fs.existsSync(p)) {
          let s = fs.readFileSync(p, 'utf8');
          if (!/components\/ui\/card/.test(s)) {
            const importLine = 'import { Card, CardTitle } from "@/components/ui/card";\\n';
            if (s.startsWith('"use client"') || s.startsWith("'use client'")) {
              const i = s.indexOf('\\n');
              s = s.slice(0, i + 1) + importLine + s.slice(i + 1);
            } else {
              s = importLine + s;
            }
            fs.writeFileSync(p, s);
            console.log('âœ… Injected Card/CardTitle import in', p);
          } else {
            console.log('â„¹ï¸ Card/CardTitle import already present in', p);
          }
        } else {
          console.log('â„¹ï¸ SharePoint page not found:', p);
        }
        NODE
        
        # Refresh lockfile for better Docker cache hits
        npm install --package-lock-only --ignore-scripts --no-audit --no-fund
        SH
      - chmod +x ci-prebuild.sh
      - bash ci-prebuild.sh

  # NOTE: The "build:" key below is NOT indented
  build:
    commands:
      # =================================================================
      # START: NEW DIAGNOSTIC COMMANDS
      # =================================================================
      - echo "--- Verifying Git Source ---"
      - echo "Current Git Commit:"
      - git log -n 1
      - echo "--------------------------"
      - echo "Checking for presence of API route files..."
      - ls -la src/app/api/sharepoint/
      - echo "--------------------------"
      - echo "Displaying content of ROOT API route file (src/app/api/sharepoint/route.ts):"
      - cat src/app/api/sharepoint/route.ts || echo "ERROR: ROOT route file not found."
      - echo "--------------------------"
      - echo "Displaying content of DYNAMIC API route file (src/app/api/sharepoint/[id]/route.ts):"
      - cat src/app/api/sharepoint/[id]/route.ts || echo "ERROR: DYNAMIC route file not found."
      - echo "--- End of Verification ---"
      # =================================================================
      # END: NEW DIAGNOSTIC COMMANDS
      # =================================================================

      - echo "ðŸš€ BUILD â€“ apply committed migrations (if any)"
      - npx prisma migrate deploy --schema=prisma/schema.prisma || true

      # âš ï¸ This will apply schema changes that do NOT have migration files.
      #    If there are destructive changes, --accept-data-loss is required.
      - echo "ðŸ—ƒï¸ BUILD â€“ sync DB to schema.prisma (auto-create/alter tables)"
      - npx prisma db push --schema=prisma/schema.prisma --skip-generate --accept-data-loss

      - echo "âš™ï¸ BUILD â€“ generate Prisma client"
      - npx prisma generate --schema=prisma/schema.prisma

      - echo "ðŸ— BUILD â€“ resolve commit hash"
      - COMMIT_HASH=$(git rev-parse --short HEAD)
      - echo "COMMIT_HASH=$COMMIT_HASH"
      - ECR_IMAGE_URI="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$IMAGE_REPO_NAME"
      - echo "ðŸ³ BUILD â€“ docker image (no-cache + pull)"
      - |
        docker build --no-cache --pull --progress=plain \
          --build-arg GIT_COMMIT_HASH="$COMMIT_HASH" \
          --build-arg DATABASE_URL="$DATABASE_URL" \
          --build-arg EMAIL_SERVER_HOST="$EMAIL_SERVER_HOST" \
          --build-arg EMAIL_SERVER_PORT="$EMAIL_SERVER_PORT" \
          --build-arg EMAIL_SERVER_USER="$EMAIL_SERVER_USER" \
          --build-arg EMAIL_SERVER_PASSWORD="$EMAIL_SERVER_PASSWORD" \
          --build-arg EMAIL_FROM="$EMAIL_FROM" \
          --build-arg NEXTAUTH_URL="$NEXTAUTH_URL" \
          --build-arg NEXTAUTH_SECRET="$NEXTAUTH_SECRET" \
          --build-arg GOOGLE_CLIENT_ID="$GOOGLE_CLIENT_ID" \
          --build-arg GOOGLE_CLIENT_SECRET="$GOOGLE_CLIENT_SECRET" \
          --build-arg AZURE_AD_CLIENT_ID="$AZURE_AD_CLIENT_ID" \
          --build-arg AZURE_AD_CLIENT_SECRET="$AZURE_AD_CLIENT_SECRET" \
          --build-arg AZURE_AD_TENANT_ID="$AZURE_AD_TENANT_ID" \
          -t "$ECR_IMAGE_URI:$COMMIT_HASH" \
          -t "$ECR_IMAGE_URI:latest" .

      - echo "ðŸ§¾ BUILD â€“ write imagedefinitions.json artifact"
      - |
        printf '[{"name":"%s","imageUri":"%s"}]\n' \
          "$CONTAINER_NAME" "$ECR_IMAGE_URI:$COMMIT_HASH" > imagedefinitions.json
        cat imagedefinitions.json

      - echo "ðŸ”‘ Login to ECR"
      - aws ecr get-login-password --region "$AWS_DEFAULT_REGION" | docker login --username AWS --password-stdin "$ECR_IMAGE_URI"

      - echo "ðŸ“¤ Push images"
      - docker push "$ECR_IMAGE_URI:$COMMIT_HASH"
      - docker push "$ECR_IMAGE_URI:latest"

  post_build:
    commands:
      - echo "ðŸ”„ Force new ECS deployment"
      - |
        aws ecs update-service \
          --cluster nartex-cluster \
          --service nartex-next-service \
          --force-new-deployment \
          --region "$AWS_DEFAULT_REGION"
